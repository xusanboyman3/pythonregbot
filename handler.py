import sqlite3
import asyncio
from aiogram import Bot, Dispatcher, types, F
from aiogram.fsm.context import FSMContext
from sqlalchemy import select, Column, Integer, String
import re
from typing import Any, Awaitable, Callable, Dict
from aiogram import BaseMiddleware
from aiogram.types import TelegramObject, ReplyKeyboardMarkup, KeyboardButton
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.filters import Command
from sqlalchemy.ext.asyncio import async_sessionmaker, create_async_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.testing.provision import create_db

# Database setup
DATABASE_URL = "sqlite+aiosqlite:///dp.sqlite3"
engine = create_async_engine(DATABASE_URL)
async_session = async_sessionmaker(engine)
Base = declarative_base()
API_TOKEN = '7234794963:AAEdW_vwTBEAqTBSRGVJk2bXB5LKzrNiSUg'
bot = Bot(token=API_TOKEN)
# Keyboards
language_keyboard = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="üá∫üáø Uz"), KeyboardButton(text='üá∑üá∫ Ru')]
    ], resize_keyboard=True, one_time_keyboard=True
)

confirm_uz = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text='‚úÖ Tastiqlayman')],
        [KeyboardButton(text='Qaytatan')]
    ], resize_keyboard=True,
    one_time_keyboard=True
)

confirm_ru = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text='‚úÖ –Ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é')],
        [KeyboardButton(text='–ù–∞–∑–∞–¥ ‚Ü©Ô∏è')]
    ], resize_keyboard=True,
    one_time_keyboard=True
)

contact_keyboard_uz = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="üìû Telefon raqamni ulashish", request_contact=True), KeyboardButton(text='Orqaga ‚Ü©Ô∏è')]
    ], resize_keyboard=True, one_time_keyboard=True
)

contact_keyboard_ru = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="üìû –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞", request_contact=True), KeyboardButton(text='–ù–∞–∑–∞–¥ ‚Ü©Ô∏è')]
    ], resize_keyboard=True, one_time_keyboard=True
)

back_uz = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="Orqaga ‚Ü©Ô∏è")]
    ], resize_keyboard=True, one_time_keyboard=True
)

back_ru = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="–ù–∞–∑–∞–¥ ‚Ü©Ô∏è")]
    ], resize_keyboard=True, one_time_keyboard=True
)

yes_uz = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="Yo'q"), KeyboardButton(text="Ha")]
    ], resize_keyboard=True, one_time_keyboard=True
)

yes_ru = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="–ù–µ—Ç"), KeyboardButton(text="–î–∞")]
    ], resize_keyboard=True, one_time_keyboard=True
)

skip_uz = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="‚ñ∂Ô∏è O‚Äòtkazib yuborish"), KeyboardButton(text="Orqaga ‚Ü©Ô∏è")]
    ], resize_keyboard=True, one_time_keyboard=True
)

skip_ru = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="–ù–∞–∑–∞–¥ ‚Ü©Ô∏è"), KeyboardButton(text="‚ñ∂Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å")]
    ], resize_keyboard=True, one_time_keyboard=True
)

register_uz = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="Anketa to'ldirish üìù")]
    ], resize_keyboard=True, one_time_keyboard=False
)

register_ru = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="–ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É üìù")]
    ], resize_keyboard=True, one_time_keyboard=False
)

gender_uz = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="üë® ErkakÔ∏è"), KeyboardButton(text="üë©‚Äçü¶∞ Ayol")],
        [KeyboardButton(text="Orqaga ‚Ü©Ô∏è")]
    ], resize_keyboard=True, one_time_keyboard=True
)

gender_ru = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="üë® –ú—É–∂—á–∏–Ω–∞Ô∏è"), KeyboardButton(text="üë©‚Äçü¶∞ –ñ–µ–Ω—â–∏–Ω–∞")],
        [KeyboardButton(text="–ù–∞–∑–∞–¥ ‚Ü©Ô∏è")]
    ], resize_keyboard=True, one_time_keyboard=True
)

education_uz = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="Oliy"), KeyboardButton(text="Magistratura")],
        [KeyboardButton(text="Talaba"), KeyboardButton(text="O'rta maxsus")],
        [KeyboardButton(text="O'rta")],
        [KeyboardButton(text="Orqaga ‚Ü©Ô∏è")]
    ], resize_keyboard=True, one_time_keyboard=True
)

education_ru = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="–í—ã—Å—à–µ–µ"), KeyboardButton(text="–ú–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞")],
        [KeyboardButton(text="–°—Ç—É–¥–µ–Ω—Ç"), KeyboardButton(text="–°—Ä–µ–¥–Ω–µ–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ")],
        [KeyboardButton(text="–°—Ä–µ–¥–Ω–µ–µ")],
        [KeyboardButton(text="–ù–∞–∑–∞–¥ ‚Ü©Ô∏è")]
    ], resize_keyboard=True, one_time_keyboard=True
)

place_uz = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text='Andijon'),
         KeyboardButton(text='Toshkent')],
        [KeyboardButton(text='Qashqadaryo'),
         KeyboardButton(text='Buhoro')],
        [KeyboardButton(text='Xiva'),
         KeyboardButton(text='Jizzax')],
        [KeyboardButton(text='Samarqand'),
         KeyboardButton(text="Farg'ona")],
        [KeyboardButton(text='Namangan'),
         KeyboardButton(text='Surxondaryo')],
        [KeyboardButton(text='Navoi'),
         KeyboardButton(text='Xorazm')]
    ], one_time_keyboard=False,
    resize_keyboard=True,
)

place_ru = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text='–ê–Ω–¥–∏–∂–∞–Ω'),
         KeyboardButton(text='–¢–∞—à–∫–µ–Ω—Ç')],
        [KeyboardButton(text='–ö–∞—à–∫–∞–¥–∞—Ä—å—è'),
         KeyboardButton(text='–ë—É—Ö–∞—Ä–∞')],
        [KeyboardButton(text='–•–∏–≤–∞'),
         KeyboardButton(text='–î–∂–∏–∑–∞–∫')],
        [KeyboardButton(text='–°–∞–º–∞—Ä–∫–∞–Ω–¥'),
         KeyboardButton(text="–§–µ—Ä–≥–∞–Ω–∞")],
        [KeyboardButton(text='–ù–∞–º–∞–Ω–≥–∞–Ω'),
         KeyboardButton(text='–°—É—Ä—Ö–∞–Ω–¥–∞—Ä—å—è')],
        [KeyboardButton(text='–ù–∞–≤–æ–∏'),
         KeyboardButton(text='–•–æ—Ä–µ–∑–º')]
    ], one_time_keyboard=False,
    resize_keyboard=True,
)

program_uz = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="Word"), KeyboardButton(text="Excel"), KeyboardButton(text='Powerpoint')],
        [KeyboardButton(text="Orqaga ‚Ü©Ô∏è")]
    ], resize_keyboard=True,
    one_time_keyboard=True
)

program_ru = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="Word"), KeyboardButton(text="Excel"), KeyboardButton(text='Powerpoint')],
        [KeyboardButton(text="–ù–∞–∑–∞–¥ ‚Ü©Ô∏è")]
    ], resize_keyboard=True,
    one_time_keyboard=True
)

family_uz = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="Turmush qurgan"), KeyboardButton(text='Turmush qurmagan')],
        [KeyboardButton(text="Ajrashgan")],
        [KeyboardButton(text="Orqaga ‚Ü©Ô∏è")],
    ], resize_keyboard=True,
    one_time_keyboard=True
)

family_ru = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="–ñ–µ–Ω–∞—Ç/–ó–∞–º—É–∂–µ–º"), KeyboardButton(text='–•–æ–ª–æ—Å—Ç/–ù–µ –∑–∞–º—É–∂–µ–º')],
        [KeyboardButton(text="–†–∞–∑–≤–µ–¥–µ–Ω")],
        [KeyboardButton(text="–ù–∞–∑–∞–¥ ‚Ü©Ô∏è")],
    ], resize_keyboard=True,
    one_time_keyboard=True
)

bot = Bot(token=API_TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)


class SMS(StatesGroup):
    message = State()
    tg_id = State()


# Define States
class REG(StatesGroup):
    tg_id = State()
    number2 = State()
    education_level = State()
    place2 = State()
    edu_name = State()
    name = State()
    last_name = State()
    age = State()
    number = State()
    place = State()
    gender = State()
    is_student = State()
    education = State()
    family = State()
    last_work1 = State()
    last_work2 = State()
    last_work3 = State()
    language = State()
    audio = State()
    skills = State()
    used_program = State()
    photo = State()
    about_bot = State()


class Leng(Base):
    __tablename__ = 'leng'

    id = Column(Integer, primary_key=True, index=True)
    tg_id = Column(Integer, unique=True, index=True)
    user_language = Column(String, index=True)


async def init_db():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)


asyncio.run(init_db())


def sanitize_value(value):
    if isinstance(value, (int, float, str)) or value is None:
        return value
    else:
        return str(value)  # Convert unsupported types to string


def create_db():
    conn = sqlite3.connect('bot_data.db')
    cursor = conn.cursor()
    cursor.execute('''CREATE TABLE IF NOT EXISTS users (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        tg_id INTEGER,
                        place2 TEXT,
                        edu_name TEXT,
                        name TEXT,
                        last_name TEXT,
                        age INTEGER,
                        number TEXT,
                        number2 INTEGER,
                        place TEXT,
                        gender TEXT,
                        is_student TEXT,
                        education TEXT,
                        family TEXT,
                        last_work1 TEXT,
                        last_work2 TEXT,
                        last_work3 TEXT,
                        language TEXT,
                        audio TEXT,
                        skills TEXT,
                        used_program TEXT,
                        photo TEXT,
                        about_bot TEXT
                    )''')
    conn.commit()
    conn.close()

create_db()


async def set_user_language(tg_id: int, language: str):
    async with async_session() as session:
        stmt = select(Leng).where(Leng.tg_id == tg_id)
        result = await session.execute(stmt)
        user = result.scalar_one_or_none()

        if user:
            user.user_language = language
        else:
            new_user = Leng(tg_id=tg_id, user_language=language)
            session.add(new_user)

        await session.commit()


async def get_user_language(tg_id: int) -> str:
    async with async_session() as session:
        stmt = select(Leng.user_language).where(Leng.tg_id == tg_id)
        result = await session.execute(stmt)
        user_language = result.scalar_one_or_none()
        return user_language


# Handlers
@dp.message(Command(commands=["start"]))
async def cmd_start(message: types.Message, state: FSMContext):
    await message.answer("Tilni tanglang / –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫", reply_markup=language_keyboard)
    await state.set_state(REG.language)


@dp.message(lambda message: message.text in ["üá∫üáø Uz", "üá∑üá∫ Ru"])
async def select_language(message: types.Message, state: FSMContext):
    tg_id = message.from_user.id
    language = 'uz' if message.text == "üá∫üáø Uz" else 'ru'

    if language == 'ru':
        await message.answer("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç", reply_markup=register_ru)
    else:
        await message.answer("Botga xush kelibsiz", reply_markup=register_uz)
    await state.update_data(language=language)
    await set_user_language(tg_id, language)


@dp.message(F.text == "Anketa to'ldirish üìù")
async def anketa_uz(message: types.Message, state: FSMContext):
    await message.answer("üë§ Ismingizni yozing:", reply_markup=back_uz)
    await state.set_state(REG.name)


@dp.message(F.text == "–ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É üìù")
async def anketa_ru(message: types.Message, state: FSMContext):
    await message.answer("üë§ –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:", reply_markup=back_ru)
    await state.set_state(REG.name)


@dp.message(REG.name)
async def process_name(message: types.Message, state: FSMContext):
    await state.update_data(name=message.text)
    user_language = await get_user_language(message.from_user.id)
    if message.text in ['Orqaga ‚Ü©Ô∏è', '–ù–∞–∑–∞–¥ ‚Ü©Ô∏è']:
        if user_language == "ru":
            await message.answer("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è", reply_markup=register_ru)
        else:
            await message.answer("Registratsiyadan o'tish uchun pastdagi tugmani bosing", reply_markup=register_uz)
        return

    if user_language == "uz":
        await message.answer("üë§ Familiyangizni yozing:", reply_markup=back_uz)
    else:
        await message.answer("üë§ –í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ–∞–º–∏–ª–∏—é:", reply_markup=back_ru)
    await state.set_state(REG.last_name)


@dp.message(REG.last_name)
async def process_last_name(message: types.Message, state: FSMContext):
    await state.update_data(last_name=message.text)
    user_language = await get_user_language(message.from_user.id)
    if message.text in ['Orqaga ‚Ü©Ô∏è', '–ù–∞–∑–∞–¥ ‚Ü©Ô∏è']:
        await state.clear()
        await state.set_state(REG.name)
        if user_language == "ru":
            await message.answer("–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?")
        else:
            await message.answer("Ismingizni kiriting")
        return
    if user_language == "uz":
        await message.answer("Tug'ilgan sanangizni kiriting üóì\nMisol uchun: 25.12.2008", reply_markup=back_uz)
    else:
        await message.answer("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è üóì\n–ü—Ä–∏–º–µ—Ä: 25.12.2008", reply_markup=back_ru)
    await state.set_state(REG.age)


@dp.message(REG.age)
async def process_age(message: types.Message, state: FSMContext):
    age_pattern = r'^\d{2}\.\d{2}\.\d{4}$'
    user_language = await get_user_language(message.from_user.id)
    if message.text in ['Orqaga ‚Ü©Ô∏è', '–ù–∞–∑–∞–¥ ‚Ü©Ô∏è']:
        await state.clear()
        await state.set_state(REG.last_name)
        if user_language == "ru":
            await message.answer("üë§ –í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ–∞–º–∏–ª–∏—é:", reply_markup=back_ru)
        else:
            await message.answer("üë§ Familiyangizni yozing:", reply_markup=back_uz)
        return

    if not re.match(age_pattern, message.text):
        if user_language == "uz":
            await message.answer("Iltimos, tug'ilgan sanangizni 12.12.1900 formatda kiriting", reply_markup=back_uz)
        else:
            await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ 12.12.1900", reply_markup=back_ru)
        return
    await state.update_data(age=message.text)
    if user_language == "uz":
        await message.answer("Telefon raqamingizni 998XXXXXXXXX formatda kiriting\nüìû Misol uchun: 998 99 999 99 99",
                             reply_markup=back_uz)
    else:
        await message.answer("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 998XXXXXXXXX\nüìû eg: 998 99 999 99 99",
                             reply_markup=back_ru)
    await state.set_state(REG.number)



@dp.message(REG.number2)
async def contact(message: types.Message, state: FSMContext):
    user_language = await get_user_language(message.from_user.id)

    if message.text in ['Orqaga ‚Ü©Ô∏è', '–ù–∞–∑–∞–¥ ‚Ü©Ô∏è']:
        await state.clear()
        await state.set_state(REG.number)
        if user_language == "ru":
            await message.answer("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 998XXXXXXXXX")
        else:
            await message.answer("Telefon raqamingizni 998 XX XXX XX XX formatida kiriting", reply_markup=back_uz)
        return

    if not message.contact:
        if user_language == 'uz':
            await message.answer("Telefon raqamni jo'natish uchun (Telefon raqamni ulashish) tugmasi ustiga bosing",
                                 reply_markup=contact_keyboard_uz)
        else:
            await message.answer('–î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É (–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞)',
                                 reply_markup=contact_keyboard_ru)
        return

    number = message.contact.phone_number
    await state.update_data(number2=number)

    if user_language == "uz":
        await message.answer("üåê Yashash manzilingiz viloyat(xaqiqiy turar joy):", reply_markup=place_uz)
    else:
        await message.answer("üåê –í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ä–µ–≥–∏–æ–Ω –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è:", reply_markup=place_ru)

    await state.set_state(REG.place)



def is_valid_phone_number(phone_number):
    pattern = re.compile(r"^\d{12}$")
    return pattern.match(phone_number) is not None


@dp.message(REG.number)
async def process_number(message: types.Message, state: FSMContext):
    user_language = await get_user_language(message.from_user.id)

    if message.text in ['Orqaga ‚Ü©Ô∏è', '–ù–∞–∑–∞–¥ ‚Ü©Ô∏è']:
        await state.clear()
        await state.set_state(REG.age)
        if user_language == "ru":
            await message.answer("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è üóì\n–ü—Ä–∏–º–µ—Ä: 25.12.2008", reply_markup=back_ru)
        else:
            await message.answer("Tug'ilgan sanangizni kiriting üóì\nMisol uchun: 25.12.2008", reply_markup=back_uz)
        return

    if not message.text or not is_valid_phone_number(message.text):
        if user_language == "uz":
            await message.answer("Iltimos, telefon raqamingizni 998XXXXXXXXX formatda kiriting")
        else:
            await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 998XXXXXXXXX")
        return

    await state.update_data(number=message.text)

    if user_language == "uz":
        await message.answer("Telefon raqamingizni yuborish uchun pastdagi tugmani bosing",
                             reply_markup=contact_keyboard_uz)
    else:
        await message.answer("–î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É (–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞)",
                             reply_markup=contact_keyboard_ru)
    await state.set_state(REG.number2)


@dp.message(REG.place)
async def process_place(message: types.Message, state: FSMContext):
    await state.update_data(place=message.text)
    user_language = await get_user_language(message.from_user.id)

    if message.text in ['Orqaga ‚Ü©Ô∏è', '–ù–∞–∑–∞–¥ ‚Ü©Ô∏è']:
        await state.clear()
        await state.set_state(REG.number)
        if user_language == "ru":
            await message.answer("üåê –í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ä–µ–≥–∏–æ–Ω –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è:", reply_markup=place_ru)
        else:
            await message.answer("üåê Yashash manzilingiz viloyat(xaqiqiy turar joy):", reply_markup=place_uz)
        return

    valid_places = [
        '–ê–Ω–¥–∏–∂–∞–Ω', '–¢–∞—à–∫–µ–Ω—Ç', '–ö–∞—à–∫–∞–¥–∞—Ä—å—è', '–ë—É—Ö–∞—Ä–∞', '–•–∏–≤–∞', '–î–∂–∏–∑–∞–∫', '–°–∞–º–∞—Ä–∫–∞–Ω–¥', '–§–µ—Ä–≥–∞–Ω–∞',
        '–ù–∞–º–∞–Ω–≥–∞–Ω', '–°—É—Ä—Ö–∞–Ω–¥–∞—Ä—å—è', '–ù–∞–≤–æ–∏', '–•–æ—Ä–µ–∑–º', 'Andijon', 'Toshkent', 'Qashqadaryo', 'Buhoro',
        'Xiva', 'Jizzax', 'Samarqand', "Farg'ona", 'Namangan', 'Surxondaryo', 'Navoi', 'Xorazm'
    ]

    if message.text not in valid_places:
        if user_language == "uz":
            await message.answer("Iltimos, tugmalardan birini tanlang", reply_markup=place_uz)
        else:
            await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤", reply_markup=place_ru)
        return

    if user_language == "uz":
        await message.answer("üßëüë© Jinsingizni tanlang:", reply_markup=gender_uz)
    else:
        await message.answer("üßëüë© –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø–æ–ª:", reply_markup=gender_ru)

    await state.set_state(REG.gender)


@dp.message(REG.gender)
async def process_gender(message: types.Message, state: FSMContext):
    await state.update_data(gender=message.text)
    user_language = await get_user_language(message.from_user.id)

    if message.text in ['Orqaga ‚Ü©Ô∏è', '–ù–∞–∑–∞–¥ ‚Ü©Ô∏è']:
        await state.clear()
        await state.set_state(REG.place)
        if user_language == "ru":
            await message.answer("üåê –í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ä–µ–≥–∏–æ–Ω –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è:", reply_markup=place_ru)
        else:
            await message.answer("üåê Yashash manzilingiz viloyat(xaqiqiy turar joy):", reply_markup=place_uz)
        return

    if message.text not in ["üë® ErkakÔ∏è", "üë©‚Äçü¶∞ Ayol", "üë® –ú—É–∂—á–∏–Ω–∞Ô∏è", "üë©‚Äçü¶∞ –ñ–µ–Ω—â–∏–Ω–∞"]:
        if user_language == "uz":
            await message.answer("Iltimos, tugmalardan birini tanlang", reply_markup=gender_uz)
        else:
            await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤", reply_markup=gender_ru)
        return

    if user_language == "uz":
        await message.answer("Siz hozirda qaysidir universitet, litsey yoki kollej talabasimisiz?", reply_markup=yes_uz)
    else:
        await message.answer("–í—ã –≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è —Å—Ç—É–¥–µ–Ω—Ç —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞, –ª–∏—Ü–µ—è –∏–ª–∏ –∫–æ–ª–ª–µ–¥–∂–∞?", reply_markup=yes_ru)
    await state.set_state(REG.is_student)


@dp.message(REG.is_student)
async def process_is_student(message: types.Message, state: FSMContext):
    await state.update_data(is_student=message.text)
    user_language = await get_user_language(message.from_user.id)
    if message.text in ['Orqaga ‚Ü©Ô∏è', '–ù–∞–∑–∞–¥ ‚Ü©Ô∏è']:
        await state.clear()
        await state.set_state(REG.gender)
        if user_language == "ru":
            await message.answer("üßëüë© –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø–æ–ª:", reply_markup=gender_ru)
        else:
            await message.answer("üßëüë© Jinsingizni tanlang:", reply_markup=gender_uz)
        return

    if message.text not in ['Ha', 'Yo\'q', '–î–∞', '–ù–µ—Ç']:
        if user_language == "uz":
            await message.answer("Iltimos, tugmalardan birini tanlang", reply_markup=yes_uz)
        else:
            await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤", reply_markup=yes_ru)
        return

    if user_language == "uz":
        await message.answer("üíº Ma ºlumotingizni tanlang:", reply_markup=education_uz)
    else:
        await message.answer("üíº –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à —É—Ä–æ–≤–µ–Ω—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è:", reply_markup=education_ru)
    await state.set_state(REG.education_level)


@dp.message(REG.education_level)
async def process_education_level(message: types.Message, state: FSMContext):
    await state.update_data(education_level=message.text)
    user_language = await get_user_language(message.from_user.id)
    if message.text in ['Orqaga ‚Ü©Ô∏è', '–ù–∞–∑–∞–¥ ‚Ü©Ô∏è']:
        await state.clear()
        await state.set_state(REG.is_student)
        if user_language == "ru":
            await message.answer("–í—ã –≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è —Å—Ç—É–¥–µ–Ω—Ç —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞, –ª–∏—Ü–µ—è –∏–ª–∏ –∫–æ–ª–ª–µ–¥–∂–∞?", reply_markup=yes_ru)
        else:
            await message.answer("Siz hozirda qaysidir universitet, litsey yoki kollej talabasimisiz?",
                                 reply_markup=yes_uz)
        return

    valid_education_levels = ['Oliy', 'Magistratura', 'Talaba', 'O\'rta maxsus', 'O\'rta', '–í—ã—Å—à–µ–µ', '–ú–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞',
                              '–°—Ç—É–¥–µ–Ω—Ç', '–°—Ä–µ–¥–Ω–µ–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ', '–°—Ä–µ–¥–Ω–µ–µ']
    if message.text not in valid_education_levels:
        if user_language == "uz":
            await message.answer("Iltimos, darajangizni tanglang", reply_markup=education_uz)
        else:
            await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤", reply_markup=education_ru)
        return

    if user_language == "uz":
        await message.answer("Ta‚Äòlim muassasasining nomi va bitirgan yilingiz:", reply_markup=skip_uz)
    else:
        await message.answer("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—á–µ–±–Ω–æ–≥–æ –∑–∞–≤–µ–¥–µ–Ω–∏—è –∏ –≥–æ–¥ –æ–∫–æ–Ω—á–∞–Ω–∏—è:", reply_markup=skip_ru)
    await state.set_state(REG.education)


@dp.message(REG.education)
async def process_education(message: types.Message, state: FSMContext):
    await state.update_data(education=message.text)
    user_language = await get_user_language(message.from_user.id)

    if message.text in ['Orqaga ‚Ü©Ô∏è', '–ù–∞–∑–∞–¥ ‚Ü©Ô∏è']:
        await state.clear()
        await state.set_state(REG.education_level)
        if user_language == "ru":
            await message.answer("üíº –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à —É—Ä–æ–≤–µ–Ω—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è:", reply_markup=education_ru)
        else:
            await message.answer("üíº Ma ºlumotingizni tanlang:", reply_markup=education_uz)
        return

    if message.text == '‚ñ∂Ô∏è O‚Äòtkazib yuborish' or message.text == '‚ñ∂Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å':
        if user_language == "ru":
            await message.answer("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –í–∞—à–µ —Å–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ:", reply_markup=family_ru)
        else:
            await message.answer("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Oilaviy ahvolingiz:", reply_markup=family_uz)
        await state.set_state(REG.family)
        return

    if user_language == "uz":
        await message.answer("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Oilaviy ahvolingiz:", reply_markup=family_uz)
    else:
        await message.answer("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –í–∞—à–µ —Å–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ:", reply_markup=family_ru)
    await state.set_state(REG.family)


@dp.message(REG.family)
async def process_family(message: types.Message, state: FSMContext):
    await state.update_data(family=message.text)
    user_language = await get_user_language(message.from_user.id)
    if message.text in ['Orqaga ‚Ü©Ô∏è', '–ù–∞–∑–∞–¥ ‚Ü©Ô∏è']:
        await state.clear()
        await state.set_state(REG.education)
        if user_language == "ru":
            await message.answer("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—á–µ–±–Ω–æ–≥–æ –∑–∞–≤–µ–¥–µ–Ω–∏—è –∏ –≥–æ–¥ –æ–∫–æ–Ω—á–∞–Ω–∏—è:", reply_markup=skip_ru)
        else:
            await message.answer("Ta‚Äòlim muassasasining nomi va bitirgan yilingiz:", reply_markup=skip_uz)
        return

    if message.text not in ["–ñ–µ–Ω–∞—Ç/–ó–∞–º—É–∂–µ–º", "–•–æ–ª–æ—Å—Ç/–ù–µ –∑–∞–º—É–∂–µ–º", "–†–∞–∑–≤–µ–¥–µ–Ω", "Turmush qurgan", "Turmush qurmagan",
                            "Ajrashgan"]:
        if user_language == "uz":
            await message.answer("Iltimos, tugmalardan birini tanlang", reply_markup=family_uz)
        else:
            await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤", reply_markup=family_ru)
        return

    if user_language == "uz":
        await message.answer('üë®‚Äçüîß Mutaxassisligingiz:', reply_markup=back_uz)
    else:
        await message.answer('üë®‚Äçüîß –í–∞—à–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:', reply_markup=back_ru)
    await state.set_state(REG.last_work1)


@dp.message(REG.last_work1)
async def process_last_work1(message: types.Message, state: FSMContext):
    await state.update_data(last_work1=message.text)
    user_language = await get_user_language(message.from_user.id)

    if message.text in ['Orqaga ‚Ü©Ô∏è', '–ù–∞–∑–∞–¥ ‚Ü©Ô∏è']:
        await state.set_state(REG.family)
        if user_language == "ru":
            await message.answer("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –í–∞—à–µ —Å–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ:", reply_markup=family_ru)
        else:
            await message.answer("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Oilaviy ahvolingiz:", reply_markup=family_uz)
        return

    if user_language == "uz":
        await message.answer('Iltimos, o\'zingiz haqingizda bizga ovozli habar jo\'nating')
    else:
        await message.answer('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∞–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–µ–±–µ')
    await state.set_state(REG.audio)


@dp.message(REG.audio)
async def process_audio(message: types.Message, state: FSMContext):
    user_language = await get_user_language(message.from_user.id)

    if message.text in ['Orqaga ‚Ü©Ô∏è', '–ù–∞–∑–∞–¥ ‚Ü©Ô∏è']:
        await state.set_state(REG.last_work1)
        if user_language == "ru":
            await message.answer('üë®‚Äçüîß –í–∞—à–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:', reply_markup=back_ru)
        else:
            await message.answer('üë®‚Äçüîß Mutaxassisligingiz:', reply_markup=back_uz)
        return

    if not message.voice:
        if user_language == "uz":
            await message.answer('üîä Iltimos ovozli habar yuboring:')
        else:
            await message.answer('üîä –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:')
        return

    print(f"Received message type: {'audio' if message.audio else 'voice' if message.voice else 'unknown'}")

    await state.update_data(audio=message.voice.file_id if message.voice else message.audio.file_id)
    user_language = await get_user_language(message.from_user.id)

    if user_language == "uz":
        await message.answer("Yaxshi qobiliyatlaringiz:")
    else:
        await message.answer("–í–∞—à–∏ –Ω–∞–≤—ã–∫–∏:")
    await state.set_state(REG.skills)


@dp.message(REG.skills)
async def process_skills(message: types.Message, state: FSMContext):
    await state.update_data(skills=message.text)
    user_language = await get_user_language(message.from_user.id)

    if message.text in ['Orqaga ‚Ü©Ô∏è', '–ù–∞–∑–∞–¥ ‚Ü©Ô∏è']:
        await state.set_state(REG.audio)
        if user_language == "ru":
            await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∞–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–µ–±–µ", reply_markup=back_ru)
        else:
            await message.answer("Iltimos, o'zingiz haqingizda bizga ovozli habar jo'nating", reply_markup=back_uz)
        return

    if user_language == "uz":
        await message.answer("üë®‚Äçüíª Qaysi dasturlardan foydalana olasiz?", reply_markup=program_uz)
    else:
        await message.answer("üë®‚Äçüíª –ö–∞–∫–∏–º–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞–º–∏ –≤—ã –≤–ª–∞–¥–µ–µ—Ç–µ?", reply_markup=program_ru)
    await state.set_state(REG.used_program)


@dp.message(REG.used_program)
async def process_used_program(message: types.Message, state: FSMContext):
    await state.update_data(used_program=message.text)
    user_language = await get_user_language(message.from_user.id)

    if message.text in ['Orqaga ‚Ü©Ô∏è', '–ù–∞–∑–∞–¥ ‚Ü©Ô∏è']:
        await state.set_state(REG.skills)
        if user_language == "ru":
            await message.answer("–í–∞—à–∏ –Ω–∞–≤—ã–∫–∏:", reply_markup=back_ru)
        else:
            await message.answer("Yaxshi qobiliyatlaringiz:", reply_markup=back_uz)
        return

    if message.text not in ["Word", "Excel", "Powerpoint"]:
        if user_language == 'uz':
            await message.answer('Iltimos tugmalardan birini tanlang', reply_markup=program_uz)
        if user_language == 'ru':
            await message.answer('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤', reply_markup=program_ru)
        return

    if user_language == "uz":
        await message.answer("Iltimos, surat yuboring", reply_markup=back_uz)
    else:
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é", reply_markup=back_ru)
    await state.set_state(REG.photo)


@dp.message(REG.photo)
async def process_photo(message: types.Message, state: FSMContext):
    user_language = await get_user_language(message.from_user.id)

    if message.text in ['Orqaga ‚Ü©Ô∏è', '–ù–∞–∑–∞–¥ ‚Ü©Ô∏è']:
        await state.set_state(REG.used_program)
        if user_language == "ru":
            await message.answer("üë®‚Äçüíª –ö–∞–∫–∏–º–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞–º–∏ –≤—ã –≤–ª–∞–¥–µ–µ—Ç–µ?", reply_markup=program_ru)
        else:
            await message.answer("üë®‚Äçüíª Qaysi dasturlardan foydalana olasiz?", reply_markup=program_uz)
        return

    if not message.photo:
        if user_language == "uz":
            await message.answer('üñº Iltimos botga o\'z rasmingizni yuboring:', reply_markup=back_uz)
        else:
            await message.answer('üñº –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–≤–æ—ë —Ñ–æ—Ç–æ:', reply_markup=back_ru)
        return

    await state.update_data(photo=message.photo[-1].file_id)

    if user_language == "uz":
        await message.answer("Biznning bot haqida fikirngiz", reply_markup=skip_uz)
    else:
        await message.answer("–ì–¥–µ –≤—ã —É–∑–Ω–∞–ª–∏ –æ –Ω–∞—à–µ–º –±–æ—Ç–µ?", reply_markup=skip_ru)
    await state.set_state(REG.about_bot)

    await state.set_state(REG.tg_id)

@dp.message(REG.tg_id)
async def tgid(message: types.Message, state: FSMContext):
    tg_id = message.from_user.id
    await state.update_data(tg_id=tg_id)
    user_language = await get_user_language(message.from_user.id)

    if user_language == "uz":
        await message.answer("Bizning bot haqida qayerdan eshitdingiz?", reply_markup=back_uz)
    else:
        await message.answer("–ì–¥–µ –≤—ã —É–∑–Ω–∞–ª–∏ –æ –Ω–∞—à–µ–º –±–æ—Ç–µ?", reply_markup=back_ru)
    await state.set_state(REG.about_bot)


@dp.message(REG.about_bot)
async def process_about_bot(message: types.Message, state: FSMContext):
    await state.update_data(about_bot=message.text)
    user_language = await get_user_language(message.from_user.id)

    if message.text == 'Qaytatan':
        await state.set_state(REG.name)
        if user_language == "ru":
            await message.answer("üë§ –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:", reply_markup=back_ru)
        else:
            await message.answer("üë§ Ismingizni yozing", reply_markup=back_uz)
        return



    if message.text in ['Orqaga ‚Ü©Ô∏è', '–ù–∞–∑–∞–¥ ‚Ü©Ô∏è']:
        await state.set_state(REG.photo)
        if user_language == "ru":
            await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é", reply_markup=back_ru)
        else:
            await message.answer("Iltimos, surat yuboring", reply_markup=back_uz)
        return


    if message.text in ['‚úÖ Tastiqlayman', '‚úÖ –Ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é']:
        if user_language == "uz":
            await message.answer("Ro'yxatdan o'tish tugadi. Rahmat!")
        else:
            await message.answer("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –°–ø–∞—Å–∏–±–æ!")
        return
    user_data = await state.get_data()
    if user_language == "uz":
        await message.answer(
            f"Ismingiz: {user_data.get('name')}\nFamiliyangiz: {user_data.get('last_name')}\nTug'ilgan yilingiz: {user_data.get('age')}\nYashash manzilingiz: {user_data.get('place')}\nJinsingiz: {user_data.get('gender')}\nStudent: {user_data.get('is_student')}\nDarajangiz: {user_data.get('education_level')}\nBiladigan tillaringiz: {user_data.get('language')},\nTelefon raqamingiz {user_data.get('number')}{user_data.get('number2')}",
            reply_markup=confirm_uz)
    else:
        await message.answer(
            f"–í–∞—à–µ –∏–º—è: {user_data.get('name')}\n–í–∞—à–∞ —Ñ–∞–º–∏–ª–∏—è: {user_data.get('last_name')}\n–í–∞—à –≥–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è: {user_data.get('age')}\n–í–∞—à –∞–¥—Ä–µ—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è: {user_data.get('place')}\n–í–∞—à –ø–æ–ª: {user_data.get('gender')}\n–°—Ç—É–¥–µ–Ω—Ç: {user_data.get('is_student')}\n–í–∞—à —É—Ä–æ–≤–µ–Ω—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è: {user_data.get('education_level')}\n–í–∞—à–∏ —è–∑—ã–∫–∏: {user_data.get('language')}\n–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: {user_data.get('number', 'number2')}",
            reply_markup=confirm_ru)


    conn = sqlite3.connect('bot_data.db')
    cursor = conn.cursor()

    cursor.execute('''INSERT INTO users (tg_id,place2, edu_name, name, last_name, age, number, number2, place, gender, is_student, education, family, last_work1, last_work2, last_work3, language, audio, skills, used_program, photo, about_bot)
                      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)''',
                   (user_data.get('tg_id'),
                    user_data.get('place2'),
                    user_data.get('edu_name'),
                    user_data.get('name'),
                    user_data.get('last_name'),
                    user_data.get('age'),
                    user_data.get('number'),
                    user_data.get('number2'),
                    user_data.get('place'),
                    user_data.get('gender'),
                    user_data.get('is_student'),
                    user_data.get('education_level'),
                    user_data.get('family'),
                    user_data.get('last_work1'),
                    user_data.get('last_work2'),
                    user_data.get('last_work3'),
                    user_data.get('language'),
                    user_data.get('audio'),
                    user_data.get('skills'),
                    user_data.get('used_program')
                    , user_data.get('photo'),
                    user_data.get('about_bot')))

    conn.commit()
    conn.close()


async def main():
    await dp.start_polling(bot)


class TestMiddleware(BaseMiddleware):
    async def __call__(self, handler: Callable[[TelegramObject, Dict[str, Any]], Awaitable[Any]], event: TelegramObject,
                       data: Dict[str, Any]) -> Any:
        print("pass")
        result = await handler(event, data)
        print("pass 2")
        return result


print('working')

if __name__ == "__main__":
    try:
        keep_alive()
        asyncio.run(main())
    except KeyboardInterrupt:
        print("Exit")
